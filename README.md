# TMS

**Transporation Management System**

경로에 영향을 줄 수 있는 변수를 사용자가 GUI를 통해 조절할 수 있도록 하여 조절값에 따라 경로가 변경되어질 수 있도록 설계했습니다.
사용된 알고리즘은 메타휴리스틱 알고리즘의 LS와 GA입니다.

# 개발 계기
특별한 계기는 아닙니다. 그저 현장실습을 하는 동안 실습인원이 3명이었던 메인 프로젝트(음성인식 모델 개발)을 하면서 새로운 프로젝트를 해보는 게 어떻겠느냐의 질문에 제가 손을 들어서 맡게되었습니다.  


# 알고리즘
`cost 개념`을 사용해 사용자가 설정한 기준에서 멀어질 수록 비용이 추가됩니다. 그 비용이 가장 적은 곳으로 먼저 가도록 구현했습니다.  
업로드 해놓은 이미지를 보면 검은 원은 `허브의 반경`을 뜻합니다. 이 반경은 허브로부터 일정 거리를 기준으로 만들었습니다.  
각 차량의 색을 다르게 하였습니다.  
빨간색 숫자로 표시되는 것은 지점의 ID라고 보시면 됩니다.  


# 파일 설명
**Local Search** 와 **Genetic Algorithm**으로 나누어져 있습니다.  
  
파일 내부는 `TMS`, `Parser`, `ui`, `Heuristic`, `Component` 로 구성되어 있습니다.  
   
- `TMS`는 실행파일입니다. GUI에서 설정한 변수 값을 이용해서 실행 됩니다.
  각 차량을 순차적으로 뽑아 진행할지, 아니면 동시에 후보군에 넣어서 가장 적은 비용을 가지는 차량을 선택하면서 진행할지를 구분했습니다. 그렇게 하다보니
  동시진행과 순차진행 버전이 생겼습니다만... 다 구현을 하고 나니 순차진행 버전은 동시진행 버전에 비해 크게 메리트가 없었지만 기록을 위해 남겨놓았습니다.  
- `Parser` 엑셀 파일로 만들어진 데이터를 읽고 정의해주는 파일입니다.  
- `ui` 는 PyQt로 만든 간단한 GUI 입니다. 여기에서 변수 값을 조절할 수 있습니다.  
- `Heuristic` 메타 휴리스틱 알고리즘을 사용하는 **메인**파일이라고 볼 수 있습니다.  
  ### ***code 파일에 주석으로 함수나 코드에 대한 부분적인 기록을 해놨지만 밑에서 조금 더 자세하게 알려드리겠습니다.***  
- `Component` 파일은 차량과 물품 등의 클래스를 정의합니다.  

# *Heuristic*에 대해서
전체적인 코드의 흐름은 `비용` 개념을 따라갑니다. 매 반복마다 가야하는 지점들에 대한 비용을 계산합니다.  
  
예를 들어 1,2,3 차량이 존재하고 A, B 지점을 가야합니다. 이 상황에서 각 차량은 클래스 객체이므로 cost_list라는 속성을 가집니다.  
  
cost_list에는 각 차량이 A, B지점을 가는 비용을 경로가 교차되었는지, 시간이 초과되었는지 등 각종 비용함수들을 통해 계산합니다.  
  
계산한 결과를 바탕으로 A지점을 가는 비용이 가장 적은 2번 차량, B지점을 가는 비용이 가장 적은 1번 차량 이런 식으로 선택됩니다.  
  
또한 차량이 가지는 cost 속성으로 현재까지의 cost를 계산합니다.  
  
조금 더 효율적인 차량 배치를 위해 Polygon을 이용합니다. 각 지점들을 연결하여 전체 Polygon을 만들고 허브를 기준으로 하여 구역을 나눕니다.  
  
각 구역을 갈 수 있는 차량을 지정하여 다른 구역에 갈 경우 큰 비용을 부과하여 가지 못하도록 만듭니다.


# 실행방법

TMS_1 을 실행하면 GUI가 뜨는데 그곳에서 지역과 값을 조절할 수 있습니다.
업로드한 이미지의 결과처럼 뜨기 위해서는
400, 3000, 7000, 0.95, 2, 2, 4000, 1000, 1000, 80, 2, 0.9, 0.9 (위에서 아래 순서) 로 설정하시면 됩니다.
필수 선택에서 순차 진행 혹은 동시 진행 1개만 선택해주세요.

# <값 설명>

![GUI](https://user-images.githubusercontent.com/110110403/230775543-0e682102-564d-42eb-8e5a-d925056345b9.png)  

`과적 금지`: 과적을 하지 않습니다.  
  
`초과 근무 금지`: 초과 근무를 하지 않습니다.  
  
`물량 비용`: 차가 가지고 있는 물량이 많을수록 물량 비용이 추가되어 적절한 물량을 유지할 수 있도록 합니다.  
  
`반경 비용`: 허브(hub)에서 일정 거리의 반경을 생성했습니다. 그 반경을 넘어가면 추가되는 비용입니다. 허브와의 적절한 거리 유지와 먼 거리를 가지 않도록 하기 위함입니다.
  
`교차 비용`: 경로가 생성될 때 불필요한 교차가 생기지 않도록 계산합니다.  
  
`최대 적재`: 과적 금지와는 다른 값으로 과적 금지의 여부에 상관 없이 최대 적재할 수 있는 양을 설정합니다. 0.8이면 80%입니다.  
  
`제한 용량`: 과적 금지의 여부에 상관 없이 최대 적재 용량에서 +x kg 까지 가능하도록 합니다.  
  
`최대 시간`: 초과 근무 금지의 여부에 상관 없이 원래 정해져 있는 근무 시간에서 +x 시간까지 근무 할 수 있도록 합니다.  
  
`차와 지점간의 거리 비용`: 현재 차가 위치 하고 있는 곳과 다음 지점간의 거리가 멀면 추가되는 비용입니다. 가까운 지점으로 먼저 갈 수 있도록 하기 위함입니다.  
  
`최대 중량 비용`: 최대 적재량으로부터 설정한 제한 용량까지 적재한 중량 비용을 부과합니다.  
  
`시간 초과 비용`: 시간을 초과하면 추가되는 비용입니다.  
  
`차량 속도`: 차량 속도를 정합니다.  
  
`상하차 시간`: 상하차 시간을 임의로 정합니다.  
  

<동시 진행만 해당> - 차량 제외 조건  
동시 진행의 경우에는 모든 차들이 예비 선상에 올라와 어떤 차가 가는 게 가장 효율적인지를 계산합니다.  
경로를 생성하면서 차량의 적재량이나 시간이 다 되었을 때 차량을 제외시킵니다.  
차량 제외를 하기 위한 조건입니다.  
  
`사용된 근무 시간의 X%를 충족하면 차량을 제외` : 예를 들어 근무시간이 9시간이라면 9시간을 꽉 채울 수도 있으나 80%만 사용되도 차량을 제외할 수 있습니다.  
  
`사용된 차의 용량의 X%를 충족하면 차량을 제외` : 정해진 차의 용량의 X%를 충족하면 차량을 제외시킵니다.  

# 어떤 어려움이 있었는지?
### 정말 수도 없이 막혔었는데 그 중 어려웠던 문제는 크게 2가지라고 생각합니다.

### 1. 알고리즘
결과적으로 이 프로젝트에서는 `비용`을 이용해 계산이 이루어집니다. 하지만 이런 방법을 쓰게 되기까지 많은 알고리즘을 생각했었고 실행에 옮겨왔습니다.  
예를 들면 이동중인 각 차량에게 `반경`이라는 속성을 적용했는데, x km 의 반경 안에 있는 지점이 있다면 반경 밖에 있는 지점보다 우선으로 갈 수 있도록 했습니다.  
그러나 계산량이 부족하다는 단점이 있었고, 그 단점을 메우기 위해 여러 개의 새로운 조건을 만들어 넣어보기도 했습니다.  
이 알고리즘의 문제점은 계산량이 늘어난다고 한들 차량의 반경 밖에 있는 지점들을 가지 않는다는 겁니다. 특히 외곽지에 있는 지점들의 경우는 더더욱이요!  
그래서 모든 경우의 수를 다 고려할 수 있도록 보완을 계속 했지만 원하는 결과가 나오지 않았습니다.  
뭔가 계속 고치면 될 것 같다는 느낌과 그동안 해왔던 작업들을 생각하니 알고리즘이 적절하지 않다는 것을 알아도 쉽게 포기할 수가 없었습니다.  
이후 상무님의 조언을 받아 `비용`개념을 이용하게 되었습니다.

### 2. 구역 나누기
위에서 Polygon을 이용해 구역을 나눈다고 말씀드렸습니다.  
![익산_점](https://user-images.githubusercontent.com/110110403/231008307-4d34a76f-251d-4d6e-905d-b90f261685d9.png)  
각 점은 배송지를 나타냅니다. 처음에는 shapely 라이브러리가 존재하는 것을 몰라서 사용하지 않았습니다.  
그래서 어떻게 전체적인 모양을 나타내야 할까 생각한 결과 **사각형** 으로 만들어 허브를 기준으로 나누면 좋을 것 같아 실행에 옮겼습니다.  
그렇다면 어떤 점을 이용해서 사각형을 만들어야 할까? 해서 동서남북을 기준으로 가장 끝 자리에 있는 점 4개를 골랐습니다.  
점 4개를 가지고 matplotlib의 plt polygon 을 이용해서 나타낸 결과 다음과 같습니다.  
![zz](https://user-images.githubusercontent.com/110110403/231009009-b460c7f2-1702-4988-aa0e-11acaf870157.png)  
네... 폴리곤이 이상하게 나왔습니다. 왜 이렇게 나오는지 테스트를 해본 결과 순서가 있었습니다.  
그 순서를 맞추기 위해 꽤 고민을 했습니다. 점의 순서를 위도나 경도의 순서로 해봤지만 `교차`로 인해 모양이 잘 만들어지지 않았습니다.  
그러면 이 `교차`를 해결해야겠구나! 해서 어느 한 점, 저는 제일 왼쪽 점을 기준으로 각 점에 대한 교차를 계산했습니다.  
어떤 방향으로 각 점을 계산할지 시계 방향, 반시계 방향을 정했습니다.  
리스트를 하나 만들어서 4개의 점의 순서들을 순열을 이용해서 넣어주고 교차가 되는 선은 제외시켜 순서를 만들수가 있었습니다.  
  
순서를 맞춰놓은 후에도 생긴 문제가 있었습니다. 다른 테스트 케이스를 실행해보면서 찾았던 문제인데,  
동서남북의 끝 점이 다 다를 수는 없다는 것입니다.  
동쪽 점과 남쪽 점이 같을 수도 있다는 것입니다 !  
일단 전체적인 구조를 갖춰놓고 세부적인 걸 수정하려는 생각에 잘 되는 테스트 케이스를 보고 일단 4등분을 하려고 다음 단계로 진행했습니다.  

#### 그렇다면 이제 어떻게 4등분을 해야하나?
4등분은 허브나 무게 중심 등을 이용해서 각 꼭짓점에 연결시켜 나눠주었는데 이 다음에서 잘못되었다 라는 것을 알게되었습니다.
  
왜 잘못되었느냐 하면... 실질적인 계산이 불가능하기 때문입니다. matplotlib 니깐요 ㅠ 막상 그 생각을 못해버린것이죠...  
여기에서 또 넓은 시각의 중요성을 깨닫게 되었습니다. 그리하여 이런 기능을 할 수 있는 라이브러리는 없을까해서 찾아보니 shapely라는 게 있어서 사용하게 되었습니다.  
shapely의 convex hull을 사용하니 너무 간단하게 모양을 만들더군요.
![익산_convex](https://user-images.githubusercontent.com/110110403/231010698-93452a5a-24dc-4b4d-8718-53094770e362.png)  
이렇게 polygon을 만들고 나니 몇 개로 나눠야할지 고민했습니다.  
각 차량을 물품을 가지고 갈 수 있는 용량이 제한되어 있고 그 용량을 효율적으로 쓰기 위해서 구역을 몇 개로 나누냐는 문제는 중요했습니다.  
이런 고민은 저번에 Heuristic 알고리즘을 짜면서 비슷한 걸 고민했었고 해결했던 기억이 났습니다.  
차량을 효율적으로 사용하기 위해서 각 지역의 배송지 수와 물품의 양을 계산해 예를 들어 A 지역은 차 4대로 갈 수 있음을 계산했습니다.  
이 부분을 이용해서 그 지역의 차량 수에 맞춰 나누게 되었습니다.  
![익산_구역](https://user-images.githubusercontent.com/110110403/231011669-67400536-dda6-46a6-8186-f6592cd569b5.png)  


# 결과와 어떤 발전을 하게 되었는지?
### 결과
창원을 예로 들겠습니다. 이 밑의 사진이 초기의 창원 경로입니다. 이 경로는 시간이나 용량 등을 고려하지 않았습니다.  
![초기_창원](https://user-images.githubusercontent.com/110110403/231012064-6904cc50-7d29-4661-8df0-64cf9a492344.png)  
  
이 밑 사진은 시간과 용량, 제약 조건을 다 고려한 창원 경로입니다.  
![창원](https://user-images.githubusercontent.com/110110403/231012125-8c66267a-cc8d-4b4d-8d33-58b0364eaaae.png)  
  
겉보기엔 많이 다른 게 없어보이지만 모든 조건이 다 고려되었음에도 충분히 괜찮은 경로를 보여줍니다.  


### 발전
배우는 학생의 입장에서 모든 프로젝트를 통해 저는 발전했다고 생각합니다.  
현장실습이긴 하지만 회사 생활을 함으로써 배울 수 있던 협동, 사회적 능력과 개발 경험을 통한 개인적인 역량 발전은 물론입니다!  
그래도 가장 많이 느꼈던 것은 `가능성`이라고 생각합니다.  

### 가능성?
`나도 이런 걸 할 수 있는 사람이구나! 그렇다면 다른 것도 할 수 있겠다.`  
AI라는 분야가 다른 분야에 비해 어렵고 평생 공부해야 한다는 말을 주변에서 들었습니다.  
과연 내가 할 수 있을까? 하며 걱정했습니다.  
걱정한 만큼 어렵고 복잡한 일도 많았지만 결국 해냈습니다. 그 일을 하며 느꼈던 즐거움, 성취감, 가능성은 곧 '동기'가 되었습니다.  



# 보완할 부분이 있다면?
- GA를 사용한 Heuristic을 조금 더 효율적으로 변경하면 더 좋았을 것 같습니다. 현재로서는 GA보다는 LS의 효율이 더 좋습니다.  
- 허브를 기준으로 구역을 나누는 알고리즘에서 크기가 동일한 Polygon으로 나누었다면 더 좋았을 거라고 생각하고 현재 보완하고 있습니다.  
  - 처음부터 그렇게 하지 못했던 이유가 각 지점들을 모아 하나의 Polygon으로 나타내었을 때 모양이 복잡한 다각형이 나오기 때문에 일정한 크기를 가진 sub polygon으로 나누기 복잡합니다.  
 
![divide](https://user-images.githubusercontent.com/110110403/230775396-48bbbf75-f5a3-470e-a50d-f79c97e1cff3.png)
